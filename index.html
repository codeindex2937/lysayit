<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>立法院會議記錄</title>
  <script src="https://unpkg.com/vue@next"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="css/style.css" rel="stylesheet" type="text/css">
  <link href="css/timeline.css" rel="stylesheet" type="text/css">
</head>

<body>
  <div class="container">
    <nav id="header">
      <h1><a href="/" class="text-danger">SayIt</a></h1>
      <ul>
        <li><a href="index.html" class="text-danger">首頁</a></li>
        <li><a href="speakers.html" class="text-danger">Speakers</a></li>
        <li><a href="index.html" class="text-danger">Speeches</a></li>
      </ul>
    </nav>
    <div id="app">
      <div class="timeline">
        <div class="line"></div>
        <div ref="timelineGroups" class="panel-group" role="tablist" aria-multiselectable="true">
          <loading v-if="!ready"></loading>
          <term :period="period" :ready="ready" v-for="period in periods" :key="period"></term>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    const app = Vue.createApp({
      data() {
        return {
          ready: false,
          periods: [],
        }
      },
      mounted() {
        this.fetchMeetings();
      },
      computed: {
        options() {
          return this.periods.map((period) => this.getGroupName(period));
        }
      },
      methods: {
        getGroupName(period) {
          if (period.term && period.period) {
            return '第' + period.term + '屆第' + period.period + '會期';
          }
    
          if (period.term && !period.period) {
            return '第' + period.term + '屆';
          }
    
          return '其他';
        },
        async fetchMeetings() {          
          const resp = await fetch('https://lysayit.g0v.ronny.tw/api/stat');
          const ret = await resp.json();

          this.periods = ret.terms.sort((a,b) => b.term - a.term).reduce((periods, term) => {
            const sorted_periods = term.periods.sort((a,b) => b.period - a.period).map((p) => {
              p.term = term.term;
              p.name = this.getGroupName(p);
              return p;
            });
            return periods.concat(sorted_periods);
          }, []);
          this.ready = true;
        },
      },
    })
    app.component('check-select', CheckSelect);

    app.component('loading', {
      template: `
      <div class="d-flex justify-content-center">
        <div class="spinner-grow text-danger" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>`,
    });

    app.component('term', {
      data() {
        return {
          ready: false,
          meetings: [],
        }
      },
      props: ['period'],
      computed: {
        collapseID() {
          return 'session-' + this.period.term + '-' + this.period.period;
        },
      },
      methods: {
        async fetchMeetings() {
          if (this.ready) {
            return;
          }

          const resp = await fetch(`https://lysayit.g0v.ronny.tw/api/meet?limit=1000&term=${this.period.term}&sessionPeriod=${this.period.period}`);
          const ret = await resp.json();

          // grouping by title
          let current_title = null;
          let current_records = null;

          ret.forEach((record) => {
            const matched = record.title.match(/(.+會期(.*?))(第(\d+)次(.+委員|聯席)?會議紀錄)/);
  
            if (matched) {
              record.meeting_title = matched[1];
              record.record_title = `${matched[3]} (${record.date})`;
              record.serial_number = parseInt(matched[4]);
            } else {
              record.meeting_title = record.title;
              record.record_title = record.date;
              record.serial_number = 0;
            }
          });
          
          this.meetings = ret.sort((a, b) => {
            if (a.meeting_title != b.meeting_title) {
              return a.meeting_title > b.meeting_title ? -1 : 1;
            }
            if (a.serial_number != b.serial_number) {
              return a.serial_number > b.serial_number ? -1 : 1;
            }
            return a.date > b.date ? -1 : 1;
          }).reduce((m, record) => {
            if (!current_title || record.meeting_title != current_title) {
              current_title = record.meeting_title;
              var meeting_id = btoa(encodeURIComponent(record.date + record.title).replace('%', '')).replaceAll('=', '');
              m.push({
                collapse_id: meeting_id,
                title: record.meeting_title,
                records: [record],
              });
            }

            m[m.length - 1].records.push(record);
            return m;
          }, []);
          this.ready = true;
        },
      },
      template: `
        <div class="panel panel-default">
          <div class="panel-heading" role="tab">
            <div class="icon"></div>
            <div
              data-toggle="collapse"
              :href="'#' + collapseID"
              @click="fetchMeetings()"
              class="period-title collapsed trigger"
            >{{ period.name }} (會議數 {{ period.meet_count }}) {{ period.date_min }} ~ {{ period.date_max }}</div>
          </div>
          <div :id="collapseID" class="panel-collapse collapse">
            <loading v-if="!ready"></loading>
            <div class="panel-body" v-for="meeting in meetings">
              <h5 class="'collapsed trigger" data-toggle="collapse" :href="'#' + meeting.collapse_id">{{ meeting.title }}</h5>
              <div :id="meeting.collapse_id" class="collapse">
                <div class="meet-card" v-for="record in meeting.records">
                  <a class="meet-desc" :href="'speech.html?id=' + encodeURIComponent(record.id)">{{ record.record_title }}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
    `
    })

    app.mount('#app')
  </script>
</body>

</html>

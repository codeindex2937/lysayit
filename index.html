<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>立法院會議記錄</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="css/style.css" rel="stylesheet" type="text/css">
  <link href="css/timeline.css" rel="stylesheet" type="text/css">
</head>

<body>
  <div class="container">
    <nav id="header">
      <h1><a href="/" class="text-danger">SayIt</a></h1>
      <ul>
        <li><a href="index.html" class="text-danger">首頁</a></li>
        <li><a href="speakers.html" class="text-danger">Speakers</a></li>
        <li><a href="index.html" class="text-danger">Speeches</a></li>
      </ul>
    </nav>
    <div class="timeline">
      <div class="line text-muted"></div>
      <div id="timeline-groups" class="panel-group" role="tablist" aria-multiselectable="true">
        <div class="d-flex justify-content-center">
          <div class="spinner-grow text-danger" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script id="tmpl-session-card" type="text/html">
<div class="panel panel-default">
 <div class="panel-heading" role="tab" id="heading">
  <div class="icon"></div>
  <div class="panel-title">
   <div class="collapsed group unload" role="button" data-toggle="collapse" href="#" aria-expanded="false" aria-controls="">
    <span class="group-name"></span>
(會議數:<span class="meet-count"></span>) <span class="date-start"></span> ~ <span class="date-end"></span>
   </div>
  </div>
 </div>
 <div class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading">
  <div class="panel-body">
 </div>
</div>
  </script>
  <script>
    function getGroupName(session, duration) {
      if (session && duration) {
        return '第' + session + '屆第' + duration + '會期';
      }

      if (session && !duration) {
        return '第' + session + '屆';
      }

      return '其他';
    }

   $.get('https://lysayit.g0v.ronny.tw/api/stat', function(ret){
     ret.terms = ret.terms.sort(function(a,b) { return b.term - a.term; });
     $('#timeline-groups').html('');
     for (var term_info of ret.terms) {
       var period_records = term_info.periods;
       term_info.periods = term_info.periods.sort(function(a,b){ return b.period - a.period; });

       for (var period_info of period_records) {
         let group_name = getGroupName(term_info.term, period_info.period);
         var session_card = $($('#tmpl-session-card').html());
         $('.group', session_card).data('term', term_info.term);
         $('.group', session_card).data('period', period_info.period);
         $('.group-name', session_card).text(group_name);
         $('.meet-count', session_card).text(period_info.meet_count);
         $('.date-start', session_card).text(period_info.date_min);
         $('.date-end', session_card).text(period_info.date_max);
         var id = 'session-' + term_info.term + '-' + period_info.period;
         $('.group', session_card).attr('href', '#' + id).attr('aria-controls', id);
         $('.panel-collapse', session_card).attr('id', id);
         $('#timeline-groups').append(session_card);
       }
     }
   }, 'json');

   $('#timeline-groups').on('click', '.group.unload', function(e){
     var parent_dom = $(this).parents('.panel');
     $('.panel-body', parent_dom).html('<div class="spinner-grow text-danger" role="status"><span class="visually-hidden">Loading...</span></div>');
     $(this).removeClass('unload');
     $.get('https://lysayit.g0v.ronny.tw/api/meet?limit=1000&term=' + $(this).data('term') + '&sessionPeriod=' + $(this).data('period'), function(ret){
         const card_body = $('.panel-body', parent_dom);
         card_body.html('');

         var date_month = null;
         var date_day = null;
         for (var record of ret) {
           if (record.date.toString().substr(0, 6) != date_month) {
             date_month = record.date.toString().substr(0, 6);
             card_body.append($('<h3></h3>').text(date_month));
           }
           if (record.date != date_day) {
             date_day = record.date;
             card_body.append($('<h4></h4>').text(date_day));
           }
           const speech_link = $('<a></a>').attr('href', 'speech.html?id=' + encodeURIComponent(record.id)).text(record.title);
           card_body.append('<div></div>').append(speech_link);
         }
     }, 'json');
   });

  </script>
</body>

</html>
